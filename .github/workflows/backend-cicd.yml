name: Backend CI/CD

on:
  workflow_dispatch:
  push:
    branches: [ "main", "dev" ]
    paths:
      - src/backend/**
      - contrib/container/**
      - .github/workflows/backend-cicd.yml
  pull_request:
    branches: [ "main", "dev" ]
    paths:
      - src/backend/**
      - contrib/container/**
      - .github/workflows/backend-cicd.yml

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:

  PYTHON_VERSION: "3.12"
  COVERAGE_THRESHOLD: "80"
  IMAGE_NAME: otask-backend

  BACKEND_DIR: ./src/backend
  SONAR_DIR: ./src/backend/otaskmanagement
  TEST_RESULTS_DIR: test-results

  POSTGRES_DB: test_db
  POSTGRES_USER: test_user
  POSTGRES_PASSWORD: test_password
  POSTGRES_HOST: localhost
  REDIS_HOST: localhost

jobs:
  lint-and-format:
    name: üõ°Ô∏è Lint & Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: ${{ env.BACKEND_DIR }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy types-redis types-requests

      - name: Ruff Format Check
        run: ruff format --check .

      - name: Ruff Lint Check
        run: ruff check .

      - name: Mypy Type Check (Strict)
        run: mypy . --ignore-missing-imports --no-incremental

  quality-check:
    name: üß™ Tests & Quality
    runs-on: ubuntu-latest
    needs: lint-and-format
    timeout-minutes: 30
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create Dummy .env
        run: |
          echo "DEBUG=True" > ./contrib/container/docker.dev.env
          echo "SECRET_KEY=ci-secret-key-for-testing" >> ./contrib/container/docker.dev.env

      - name: Build Test Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./contrib/container/Dockerfile
          push: false
          load: true
          tags: ${{ env.IMAGE_NAME }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Migrations & Tests
        run: |
          mkdir -p ${{ github.workspace }}/${{ env.TEST_RESULTS_DIR }}
          chmod 777 ${{ github.workspace }}/${{ env.TEST_RESULTS_DIR }}

          docker run --rm \
            --network host \
            -e POSTGRES_HOST=${{ env.POSTGRES_HOST }} \
            -e POSTGRES_PORT=5432 \
            -e POSTGRES_DB=${{ env.POSTGRES_DB }} \
            -e POSTGRES_USER=${{ env.POSTGRES_USER }} \
            -e POSTGRES_PASSWORD=${{ env.POSTGRES_PASSWORD }} \
            -e REDIS_URL=redis://${{ env.REDIS_HOST }}:6379/0 \
            -e CI=true \
            --env-file ./contrib/container/docker.dev.env \
            -v ${{ github.workspace }}/${{ env.TEST_RESULTS_DIR }}:/app/test-results \
            ${{ env.IMAGE_NAME }}:test \
            sh -c "
              set -e
              python manage.py migrate --no-input
              coverage run --source='.' \
                --omit='*/migrations/*,*/tests/*,manage.py' \
                manage.py test --no-input --verbosity=2 && \
              coverage xml -o /app/test-results/coverage.xml && \
              coverage report
            "

      - name: Robust Coverage Check
        id: coverage-check
        continue-on-error: ${{ github.ref != 'refs/heads/main' }}
        run: |
          python3 -c "
          import xml.etree.ElementTree as ET
          import sys
          import os

          file_path = '${{ env.TEST_RESULTS_DIR }}/coverage.xml'
          threshold = int('${{ env.COVERAGE_THRESHOLD }}')

          if not os.path.exists(file_path):
              print('‚ùå Coverage file not found!')
              sys.exit(1)

          try:
              tree = ET.parse(file_path)
              rate = float(tree.getroot().attrib.get('line-rate', 0))
              percent = int(rate * 100)

              print(f'::notice title=Coverage Report::Current: {percent}% | Required: {threshold}%')

              if percent < threshold:
                  print(f'::error::Coverage {percent}% is below threshold {threshold}%')
                  sys.exit(1)
              else:
                  print('‚úÖ Coverage Requirement Met')
          except Exception as e:
              print(f'::error::Failed to parse coverage: {e}')
              sys.exit(1)
          "


      - name: SonarQube Scan (dev only)
        continue-on-error: true  
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN_BE }}
        with:
          projectBaseDir: ${{ env.SONAR_DIR }}
          args: >
            -Dsonar.python.coverage.reportPaths=../../${{ env.TEST_RESULTS_DIR }}/coverage.xml
            -Dsonar.projectVersion=${{ github.sha }}
            -Dsonar.scm.provider=git


  security-scan:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@0.29.0
        with:
          scan-type: 'fs'
          scan-ref: ${{ env.BACKEND_DIR }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

  build-and-push:
    name: üê≥ Build & Push
    needs: [quality-check, security-scan]
    if: always() && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./contrib/container/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  smoke-test:
    name: üö¨ Smoke Test
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - name: Pull & Run Application
        run: |
          IMAGE_TAG=${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}-$(git rev-parse --short HEAD)
          docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          
          echo "Starting Container..."
          docker run -d --name smoke-app \
            --network host \
            -e POSTGRES_HOST=localhost \
            -e POSTGRES_DB=${{ env.POSTGRES_DB }} \
            -e POSTGRES_USER=${{ env.POSTGRES_USER }} \
            -e POSTGRES_PASSWORD=${{ env.POSTGRES_PASSWORD }} \
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest

      - name: Wait for Application Ready
        timeout-minutes: 2
        run: |
          echo "Waiting for Django check..."
          RETRIES=30
          until docker exec smoke-app python manage.py check --deploy > /dev/null 2>&1 || [ $RETRIES -eq 0 ]; do
            echo "Waiting for app to start... ($RETRIES remaining)"
            RETRIES=$((RETRIES-1))
            sleep 2
          done

          if [ $RETRIES -eq 0 ]; then
            echo "‚ùå Application failed to start properly."
            docker logs smoke-app
            exit 1
          fi
          
          echo "‚úÖ Application is Healthy!"

      - name: Cleanup
        if: always()
        run: docker rm -f smoke-app || true